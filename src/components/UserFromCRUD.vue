<template>
  <div class="mt-3">
    <div class="row">
      <div class="col-12" style="max-width: 720px">
        <form
          @submit.prevent="handleSubmit"
          ref="myForm"
          class="needs-validation"
          novalidate
        >
          <!-- –õ–∏–Ω–∏—è 1 -->
          <div class="row mb-3">
            <div
              class="col-md-4"
              title="–§–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –¥–µ—Ñ–∏—Å"
            >
              <label for="last_name" class="form-label">–§–∞–º–∏–ª–∏—è</label>
              <input
                type="text"
                class="form-control"
                id="last_name"
                name="last_name"
                required
                pattern="^$|^[A-Za-z–ê-–Ø–∞-—è–Å—ë\s\-]+$"
              />
              <div class="invalid-feedback">
                –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email!
              </div>
            </div>
            <div
              class="col-md-4"
              title="–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –¥–µ—Ñ–∏—Å"
            >
              <label for="name" class="form-label">–ò–º—è</label>
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                required
                pattern="^$|^[A-Za-z–ê-–Ø–∞-—è–Å—ë\s\-]+$"
              />
            </div>
            <div
              class="col-md-4"
              title="–û—Ç—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ –¥–µ—Ñ–∏—Å"
            >
              <label for="surname" class="form-label">–û—Ç—á–µ—Å—Ç–≤–æ</label>
              <input
                type="text"
                class="form-control"
                id="surname"
                name="surname"
                placeholder="–û—Ç—á–µ—Å—Ç–≤–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                pattern="^$|^[A-Za-z–ê-–Ø–∞-—è–Å—ë\s\-]+$"
              />
            </div>
          </div>

          <!-- –õ–∏–Ω–∏—è 2 -->
          <div class="row mb-3" title="–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ‚Äî 16 –ª–µ—Ç">
            <div class="col-md-6">
              <label for="date_birth" class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
              <input
                type="date"
                class="form-control"
                id="date_birth"
                name="date_birth"
                required
                :max="maxDate"
              />
            </div>
            <div
              class="col-md-6"
              title="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–∑ 9 —Ü–∏—Ñ—Ä, —Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã +992 –∏–ª–∏ –±–µ–∑ –Ω–µ–≥–æ"
            >
              <label for="phone_number" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
              <input
                type="tel"
                class="form-control"
                id="phone_number"
                name="phone_number"
                pattern="^(\+992)?\d{9}$"
                placeholder="+992XXXXXXXXX"
              />
            </div>
          </div>

          <!-- –õ–∏–Ω–∏—è 3 -->
          <div
            class="row mb-3"
            title="–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –±—É–∫–≤—ã –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—Ç 4 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤ (–±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è)"
          >
            <div class="col-md-5">
              <label for="login" class="form-label">–õ–æ–≥–∏–Ω</label>
              <input
                type="text"
                class="form-control"
                id="login"
                name="login"
                pattern="^[A-Za-z][A-Za-z0-9_]{3,19}$"
                placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ª–æ–≥–∏–Ω"
                required
              />
            </div>
            <div class="col-md-7" title="–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –±—É–∫–≤—É –∏ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤">
              <label for="pass" class="form-label">–ü–∞—Ä–æ–ª—å</label>
              <div class="input-group">
                <input
                  type="password"
                  v-model="password"
                  class="form-control"
                  name="pass"
                  id="pass"
                  required
                  pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$"
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  @click="generatePassword"
                >
                  üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  @click="togglePassword"
                >
                  üëÅ
                </button>
              </div>
            </div>
          </div>

          <!-- –†–æ–ª—å -->
          <div class="mb-3">
            <label for="role" class="form-label">–†–æ–ª—å</label>
            <select class="form-select" id="role" name="role" v-model="selectedRole" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
              <option v-for="role in roles" :value="role.code">
                {{ role.title }}
              </option>
            </select>
          </div>

          <!-- –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è -->
          <div class="mb-3" v-if="isSystemAdmin && selectedRole === 'LabDirector'">
            <label for="lab" class="form-label">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è</label>
            <select class="form-select" id="lab" name="lab_id" required>
              <option value="">–£–∫–∞–∂–∏—Ç–µ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é</option>
              <option v-for="lab in labs" :value="lab.id">
                {{ lab.name }}
              </option>
            </select>
          </div>

          <!-- –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
          <div class="mb-3">
            <label for="specialization" class="form-label">–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</label>
            <input
              type="text"
              class="form-control"
              id="specialization"
              name="specialization"
            />
          </div>

          <spinner v-if="isSaving" />
          <button
            v-else
            type="submit"
            class="btn btn-primary w-100 brand-style"
          >
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
          </button>
        </form>
      </div>
    </div>
  </div>
</template>

<script>
import { mapGetters, mapActions } from "vuex";
import {
  CURRENT_USER,
  ADD_USER,
  ACCESS_TOKEN,
  LOAD_ROLES,
  ROLES,
  IS_LAB_DIRECTOR,
  IS_SYSTEM_ADMIN,
  LABS,
  LOAD_LABS,
} from "../store/types";
import Spinner from "./Spinner.vue";
import labs from "../store/modules/labs";

/**
 * –ö–æ–º–ø–æ–Ω–µ–Ω—Ç "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"
 *
 * @vue-computed {object} currentUser - –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
 */
export default {
  name: "UserFormCRUD",
  components: {
    Spinner,
  },
  data() {
    return {
      isSaving: false,
      password: "",
      showPassword: false,
      selectedRole: ""
    };
  },
  async beforeMount() {
    await this.loadRoles();
    if (this.isSystemAdmin) {
      await this.loadLabs();
    }
  },
  computed: {
    ...mapGetters({
      currentUser: CURRENT_USER,
      accessToken: ACCESS_TOKEN,
      roles: ROLES,
      isLabDirector: IS_LAB_DIRECTOR,
      isSystemAdmin: IS_SYSTEM_ADMIN,
      labs: LABS
    }),
    maxDate() {
      const today = new Date();

      // –ì–æ–¥, —Ä–∞–≤–Ω—ã–π —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º—É –º–∏–Ω—É—Å 16
      const minYear = today.getFullYear() - 16;

      // –ú–µ—Å—è—Ü (–Ω—É–º–µ—Ä–∞—Ü–∏—è —Å 0, –ø–æ—ç—Ç–æ–º—É +1), —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤–µ–¥—É—â–µ–≥–æ –Ω—É–ª—è
      const month = String(today.getMonth() + 1).padStart(2, "0");

      // –î–µ–Ω—å —Å –≤–µ–¥—É—â–∏–º –Ω—É–ª—ë–º
      const day = String(today.getDate()).padStart(2, "0");

      // –§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–∞ max: YYYY-MM-DD
      return `${minYear}-${month}-${day}`;
    },
  },
  methods: {
    ...mapActions({
      createUser: ADD_USER,
      loadRoles: LOAD_ROLES,
      loadLabs: LOAD_LABS
    }),
    generatePassword() {
      const chars =
        "abcd123456789";
      let pass = "";
      for (let i = 0; i < 10; i++) {
        pass += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      this.password = pass;
    },
    togglePassword() {
      const input = document.getElementById("pass");
      this.showPassword = !this.showPassword;
      input.type = this.showPassword ? "text" : "password";
    },
    async handleSubmit() {
      const form = this.$refs.myForm;
      if (form.checkValidity()) {
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        this.isSaving = true;
        let params = {
          ...data,
          callback: (u) => {
            if (!this.isLabDirector) {
              this.$toast(
                `–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ ${u.full_name} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.`,
                10000
              );
            }

            this.$router.push("/users");
            return;
          },
        };
        await this.createUser(params);
        this.isSaving = false;
        console.log(data);
      } else {
        form.reportValidity(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
      }
    },
  },
};
</script>
